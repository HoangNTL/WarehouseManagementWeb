@{
    ViewBag.Title = "Thêm mới hóa đơn nhập";
}
<div class="card card-primary">
    <div class="card-header">
        <h3 class="card-title">Thêm mới hóa đơn nhập</h3>
    </div>
    <div class="card-body">
        <form id="formHoaDonNhap">
            <div class="card-body">
                <div class="form-group">
                    <label for="MaHD">Mã hóa đơn:</label>
                    <input type="text" class="form-control" id="MaHD" name="InvoiceCode" placeholder="Mã hóa đơn">
                </div>
                <div class="form-group">
                    <label for="NgayNhap">Ngày nhập:</label>
                    <div class="input-group date" id="reservationdatetime" data-target-input="nearest">
                        <input type="text" id="NgayNhap" name="ImportDate"
                               class="form-control datetimepicker-input"
                               data-target="#reservationdatetime"
                               placeholder="Chọn ngày và giờ nhập" />
                        <div class="input-group-append" data-target="#reservationdatetime" data-toggle="datetimepicker">
                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="NhaCungCap">Nhà cung cấp:</label>
                    <input type="text" class="form-control" id="NhaCungCap" name="SupplierName" placeholder="Tên nhà cung cấp">
                </div>
                <div class="form-group">
                    <label for="NhanVien">Nhân viên nhập:</label>
                    <input type="text" class="form-control" id="NhanVien" name="Staff" placeholder="Tên nhân viên">
                </div>
                <div class="form-group">
                    <label for="GhiChu">Ghi chú:</label>
                    <textarea class="form-control" id="GhiChu" name="Note" placeholder="Ghi chú thêm (nếu có)"></textarea>
                </div>

                <hr />
                <h5>Chi tiết hóa đơn:</h5>

                <div class="form-group">
                    <label>Chọn sản phẩm:</label>
                    <select class="custom-select" id="ProductId" name="ProductId" multiple>
                        <option value="">-- Chọn sản phẩm --</option>
                    </select>
                </div>
                @*<div class="form-group">
            <label>Số lượng:</label>
            <input type="number" class="form-control" id="Quantity" name="Quantity" placeholder="Nhập số lượng">
        </div>
        <div class="form-group">
            <label>Đơn giá:</label>
            <input type="number" step="0.01" class="form-control" id="UnitPrice" name="UnitPrice" placeholder="Nhập đơn giá">
        </div>*@
                <div class="form-group">
                    <label>Chi tiết sản phẩm đã chọn:</label>
                    <table class="table table-bordered" id="productDetailsTable">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer">
                <button type="submit" class="btn btn-primary">Thêm hóa đơn</button>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        $('#reservationdatetime').datetimepicker({ icons: { time: 'far fa-clock' }, format: 'YYYY-MM-DD' });
    });

let allProducts = [];

$(document).ready(function () {
    const $productSelect = $('#ProductId');
    const $productTableBody = $('#productDetailsTable tbody');

    // Load sản phẩm
    $.ajax({
        url: '@Url.Action("GetProductsAjax", "Product")',
        type: 'GET',
        dataType: 'json',
        success: function (data) {
            allProducts = data;
            data.forEach(item => {
                $productSelect.append(`<option value="${item.Id}">${item.Name} (${item.Code})</option>`);
            });
        }
    });

    // Khi chọn sản phẩm
    $productSelect.on('change', function () {
        const selectedIds = $(this).val() || [];

        $productTableBody.empty();

        selectedIds.forEach(id => {
            const product = allProducts.find(p => p.Id == id);
            if (product) {
                $productTableBody.append(`
                <tr data-id="${product.Id}">
                    <td>${product.Name} (${product.Code})</td>
                    <td><input type="number" class="form-control quantity" value="1" /></td>
                    <td><input type="number" class="form-control unit-price" step="0.01" value="0" /></td>
                </tr>
            `);
            }
        });
    });

    // Submit form
    $('#formHoaDonNhap').submit(function (event) {
        event.preventDefault();

        //const details = [];
        //$('#productDetailsTable tbody tr').each(function () {
        //    const id = $(this).data('id');
        //    const quantity = $(this).find('.quantity').val();
        //    const unitPrice = $(this).find('.unit-price').val();

        //    details.push({
        //        P: id,
        //        Quantity: quantity,
        //        UnitPrice: unitPrice
        //    });
        //});

        const products = [];
        $('#productDetailsTable tbody tr').each(function () {
            const id = $(this).data('id');
            const quantity = parseInt($(this).find('.quantity').val());
            const unitPrice = parseFloat($(this).find('.unit-price').val());

            const product = allProducts.find(p => p.Id == id);
            if (product) {
                products.push({
                    ProductCode: product.Code,
                    ProductName: product.Name,
                    Unit: product.Unit || "", // Nếu có đơn vị
                    UnitPrice: unitPrice,
                    Quantity: quantity
                });
            }
        });

        console.log(products); // -> mảng các sản phẩm đã chọn

        const invoiceData = {
            InvoiceCode: $('#MaHD').val(),
            ImportDate: $('#NgayNhap').val(),
            SupplierName: $('#NhaCungCap').val(),
            //Staff: $('#NhanVien').val(),
            Note: $('#GhiChu').val(),
            //Details: details
            Products: products
        };

        console.log(invoiceData); // -> đối tượng hóa đơn nhập

        $.ajax({
            url: '@Url.Action("Create", "ImportInvoice")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(invoiceData),
            success: function (response) {
                alert(response.message || 'Thêm hóa đơn thành công!');
                $('#formHoaDonNhap')[0].reset();
                $productTableBody.empty();
                $('#ProductId').val([]).trigger('change');
            },
            error: function () {
                alert('Đã xảy ra lỗi khi thêm hóa đơn.');
            }
        });
    });
});

</script>
